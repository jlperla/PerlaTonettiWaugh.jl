% !TEX program = pdflatex
% !BIB program = bibtex
\documentclass[11pt]{article}
\usepackage{amsmath,amsfonts,amsthm,amssymb,geometry,dsfont,natbib}
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\usepackage[
bookmarks=false,
pdfstartview={FitV},
pdftitle={Equilibrium Technology Diffusion, Trade, and Growth: Computational Appendix},
pdfauthor={Jesse Perla, Christopher Tonetti, Michael E. Waugh},
pdfcreator={Jesse Perla, Christopher Tonetti, Michael E. Waugh},
pdfkeywords={economics,international,growth,technology diffusion, trade, Perla, Tonetti, Waugh},
colorlinks=true,
linkcolor=darkgray,
citecolor=darkgray,
urlcolor=darkgray,
filecolor=darkgray,
anchorcolor=darkgray,
breaklinks]
{hyperref}
\usepackage[capitalise,noabbrev]{cleveref} %
\crefname{equation}{}{} %
\crefname{assumption}{Assumption}{Assumptions}
\crefname{property}{Property}{Properties}
\geometry{left=1in,right=1in,top=0.6in,bottom=1in}
\bibliographystyle{ecta}
\newcommand{\D}[1][]{\ensuremath{\boldsymbol{\partial}_{#1}}}
\newcommand{\R}{\ensuremath{\mathbb{R}}}
\newcommand{\diff}{\ensuremath{\mathrm{d}}}
\newcommand{\ex}{\ensuremath{\mathrm{ex}}}
\newcommand{\set}[1]{\ensuremath{\left\{{#1}\right\}}}
\newcommand{\indicator}[1]{\ensuremath{\mathds{1}\left\{{#1}\right\}}}
\newcommand{\condexpec}[3][]{\ensuremath{\mathbb{E}_{#1}\left[{#2} \; \middle| \; {#3} \right]}}
\newcommand{\expec}[2][]{\ensuremath{\mathbb{E}_{{#1}}\left[ {#2} \right]}}

\newenvironment{psmallmatrix}
{\left(\begin{smallmatrix}}
	{\end{smallmatrix}\right)}

\begin{document}
\title{Equilibrium Technology Diffusion, Trade, and Growth\\Online Computational Appendix\thanks{Thanks to Ben Moll for advice on numerical methods and his superb lecture notes.  Excellent research assistance was provided by Chiyoung Ahn, Sev Hou, Arnav Sood, and Dongxiao Zhang.  Also,we appreciate all of the help from Chris Rackauckas, Yingbo Ma, and Xingjian Guo for the Julia DiffEq package and expertise.}}
\author{Jesse Perla \and Christopher Tonetti \and Michael E. Waugh}
\maketitle

\noindent See \url{https://github.com/jlperla/PerlaTonettiWaugh.jl} for the code and instructions.
\bigskip

This document is a self-contained summary of all of the equations and algorithms used to solve the model and transition dynamics.  Equations in the code have a comment to reference the corresponding equation numbers in this document.

\cite{AchdouHanLasryEtAl2017} and its technical appendix provide many of the details on the upwind finite difference methods used here.  While using these techniques to discretize the ``spatial'' dimension, we make several changes to the general approach taken by many economists to solve PDEs: (1) after discretizing the spatial dimension of the PDE to make them ODEs, we stack in further equilibrium equations into the ODEs to make them a system of DAEs; and (2) instead of discretizing the spatial dimension with finite differences and the time-dimension with a homegrown time-stepping (e.g. backwards euler), we instead rely on the underlying ODE/DAE solvers to do numerically stable, efficient, and often adaptive--time-stepping.  Hence, we concentrate on specifying the full set of ODE/DAE equations, which are then handed over to industrial strength solvers.

\section{Simplified Growth Model with Transition Dynamics}
We start with a simplified version of the model with transition dynamics.  In the more complicated case of this paper, the $\pi(z,t), r(t), x(t)$ will come from equilibrium conditions rather than being given exogenously, but the structure of solving the resulting system of integro-differential-algebraic equations remains the same.

There is a useful simplifying result in both this minimal and the full model: in the transition dynamics experiments we are looking at, the normalized distribution $F(z)$ will remain constant over time.  Hence, we do not need to jointly solve the KFE as we will be at the stationary level (post-normalization).  This is a consequence of the PDF remaining stationary (after normalization) under the transition dynamics we examine, and is a result from the theory, \textbf{not} an assumption.

\subsection{Summary of Equations}\label{sec:summary-simple}
We follow the notation of the main paper wherever possible.  This model is the geometric Brownian motion (GBM) model in the technical appendix of \cite{BenhabibPerlaTonetti2017}.

Let $Z$ be productivity, where $Z(t) \geq M(t)$.  Let $V(Z,t)$ is the value function prior to normalization, $M(t)$ the endogenous threshold, $\Pi(Z,t)$ the profits, and $X(t)$ the adoption cost.  The $\Pi(Z,t)$, $r$, and $X(t)$ are given exogenously in this simplified version, and endogenized with monopolistic competition and trade in the full model.

Define the normalization that $z \equiv \log(Z/M(t))$, $v(z,t) \equiv \frac{e^{-z}}{M(t)}V(M(t)e^z, t))$, $\pi(z,t) \equiv \frac{e^{-z}}{M(t)}\Pi(M(t)e^z, t))$, and $x(t) \equiv X(t)/M(t)$.  \cref{sec:simple-derivation} shows that the rescaled system of equations is
\begin{align}
\D[t]v(z,t) &= A(t)v(z,t) - \pi(z,t)\label{eq:simple-summary1}\\
v(0,t) &= \int_{0}^{\infty}  v(z,t) \left(e^z F'(z)\right) \diff z - x(t)\label{eq:simple-summary2}\\
\D[z]v(0,t) + v(0,t) &= 0\label{eq:simple-summary3}\\
\intertext{Given the differential operator,}
A(t) &\equiv \left(r - \mu - \frac{\upsilon^2}{2}\right) - (\mu+ \upsilon^2 - g(t)) \D[z] - \frac{\upsilon^2}{2} \D[zz]\label{eq:simple-summary4}\\
\intertext{Where the normalized distribution for all $t$ is}
F(z) &= 1 - e^{-\theta z}
\end{align}

\subsection{Analytic Steady State}\label{sec:simple-steady-state}
For the exogenous $\pi(z,t)$ and $x(t)$ we require that at some $T < \infty$ it becomes stationary.  Hence we will assume with little loss of generality that,\footnote{Note that the $\pi(z,T) = 1$ requires that pre-normalized profits are $\Pi(Z,T) \propto e^Z$.  With different functional forms of the profits, we would rescale by a different power in the exponential--such as the $e^{-\xi z}$ in the full model.}
\begin{align}
x(t) &= \zeta,\quad \text{ for all }t \geq T\label{eq:terminal-x}\\
\pi(z,t) &= 1,\quad \text{ for all }t \geq T\label{eq:terminal-pi}\\
f(z,t) &= \theta e^{-\theta z},\quad \text{ for all }t \label{eq:f-stationary-summary}
\end{align}




\noindent \cite{BenhabibPerlaTonetti2017} gives us a closed-form solution for this balanced growth path (i.e., steady state when normalized)

\begin{align}
g \equiv g(T) &= 	\mu+ \frac{1-(\theta -1) \zeta  \left(r-\mu\right)}{(\theta -1)^2 \zeta }+ \frac{\upsilon^2}{2}\frac{\theta  \left(\theta(\theta -1)    \left(r-\mu-\frac{\upsilon ^2}{2}\right) \zeta-2\right)+1}{(\theta -1) \left((\theta -1)   \left(r-\mu-\frac{\upsilon ^2}{2}\right)\zeta-1\right)}. \label{eq:g-gbm}\\
v(z,T) &= \frac1{r-\mu- \upsilon^2/2}\left(1 + \frac1{\nu} e^{-(\nu + 1) z}\right)\label{eq:v-gbm-sol},
\intertext{where,}
\nu &\equiv  \frac{\mu- g}{\upsilon^2} + \sqrt{\left(\frac{g-\mu}{\upsilon^2} \right)^{2} + \frac{r-g}{\upsilon^2/2}}. \label{eq:nu-gbm}
\end{align}

Note: since $v(z,T)$ has been rescaled by $e^{-z}$ above, it is now a \textbf{decreasing} function in $z$.  This will lead to appealing numerical properties when solving the PDE for $v(t,z)$ since it becomes asymptotically constant as $z \to \infty$ for any $t$.


\subsection{Summary of Equations For Numerical Solution}\label{sec:summary-simple-numerical}
To solve the model numerically, we need to bound the state space by adding an artificial upper bound, $\bar{z}$.  With this and using the derivation in \cref{sec:simple-derivation}, the equations of \cref{sec:summary-simple} become,

\begin{align}
\D[t]v(z,t) &= A(t)v(z,t) - \pi(z,t)\label{eq:simple-summary1-numerical}\\
v(0,t) &= \int_{0}^{\bar{z}}  v(z,t) \left(e^z \frac{F'(z)}{F(\bar{z})}\right) \diff z - x(t)\label{eq:simple-summary2-numerical}\\
\D[z]v(0,t) + v(0,t) &= 0\label{eq:simple-summary3-numerical}\\
\D[z]v(\bar{z},t) + v(\bar{z},t) &= 0\label{eq:simple-summary4-numerical}\\
\intertext{With the same operator $A(t)$ in \cref{eq:simple-summary4} now defined on $z \in (0,\bar{z})$}
A(t) &\equiv \left(r - \mu - \frac{\upsilon^2}{2}\right) - (\mu+ \upsilon^2 - g(t)) \D[z] - \frac{\upsilon^2}{2} \D[zz]\label{eq:simple-summary5-numerical}
\end{align}

\noindent A solution is a $g(t)$ and $v(z,t)$ such that this system of equations holds.\footnote{\textbf{Note:} in this class of models, it is known that if the distribution was forced to have a finite-support with a fixed frontier, it would lead to no long-run growth.  This is not what the artificial boundary is doing.  In particular, the pre-normalized boundary is growing at the same rate as the economy, i.e., $\bar{Z}(t) = M(t) e^{\bar{z}}$.  We have numerically verified that for a large $\bar{z}$, this converges to the known analytic solution with an infinite support.}

\subsection{Spatial Discretization with Upwind Finite-Differences}

In order to solve for the dynamics of $v(z,t)$ and $g(t)$, we will discretize the PDE, integral, and algebraic equations from \cref{eq:simple-summary1-numerical,eq:simple-summary2-numerical,eq:simple-summary3-numerical,eq:simple-summary4-numerical} into a system of ODEs and algebraic equations.\footnote{As a test, we solve the steady state version of the discretized system of ODEs numerically and compare it to the closed-form solution in \cref{sec:simple-steady-state} to determine the degree of numerical error and stability of the methods.}


\paragraph{Grid}
The core PDE in \cref{eq:simple-summary1-numerical} is defined on the interior of the domain, i.e., $z \in (0, \bar{z})$ while the boundary conditions are defined on the closure $z \in [0,\bar{z}]$.  To aid the implementation, define the potentially irregular grid on $[0,\bar{z}]$
\begin{align}
	z_{\ex} &= \set{z_i}_{i=0}^{P+1} \in \R^{P+2},
\end{align}
where $z_0 = 0$ and $z_{P+1} = \bar{z}$ is a ``large'' number (keeping in mind that the effective number is $e^{\bar{z}}$).

We abuse notation and use $z$ to denote the grid on the interior, representing where the PDE holds outside of boundary conditions.  That is,
\begin{align}
	z &= \set{z_i}_{i=1}^P \in \R^{P},
\end{align}

where we note that $z \equiv z_{\ex}[2:P+1] = \set{z_1, z_2, \ldots z_P}$.\footnote{Throughout this document, when we use the $[ ]$ to access within an array, it has $1$ based indices.}  Consequently, after discretizing, the PDE will be solved on the interior $\set{z_i}_{i=1}^P$ and the boundary conditions for $z_0 = 0$ and $z_{P+1} = \bar{z}$ will be fulfilled by the solution through the discretization approach.

\paragraph{Discretized Functions}

After discretizing, we abuse notation and denote the grid by the variable name, i.e., $z \equiv \set{z_i}_{i=1}^{P}$.  We also denote discretized function with the same symbol, but dropping the dependence on $z$.  In the case of the payoffs and resulting functions, they are only defined on the interior, i.e., $\pi(t) \equiv \set{\pi(z_i,t)}_{i=1}^P\in \R^P$ and $v(t) \equiv \set{v(z_i,t)}_{i=1}^P\in \R^P$.

\paragraph{Discretized Operator}

To discretize the system, we use upwind finite differences.  In particular, we need to discretize the differential operator in \cref{eq:simple-summary5-numerical} subject to the \cref{eq:simple-summary3-numerical,eq:simple-summary4-numerical} boundary conditions.  Crucially, since these boundary conditions are homogeneous, we can decompose the linear $A(t)$ operator into additive parts where: the $\D[z]$ is discretized as $L^{-}_1$ using backwards first differences, and the $\D[zz]$ is discretized as $L_2$ using central second difference.   Furthermore, the $L^{-}_1$ and $L_2$ linear operators \textit{impose the boundary conditions \cref{eq:simple-summary3-numerical,eq:simple-summary4-numerical} for any vector} they operator on.

See \cref{sec:discretized-operators} for the formulas for $L_1^-$ and $L_2$, and \url{https://github.com/QuantEcon/SimpleDifferentialOperators.jl/releases/download/dev/discretized-differential-operator-derivation.pdf} for the derivations.  While the full equations are complicated by the irregular grids and boundary conditions, for intuition note that the discretization of the $L_1^-$ backwards first difference operator is such that in the interior
$$
\D[z] v(z_i) \approx L_1^{-}\, v(z_i) = \frac{v_i - v_{i-1}}{z_i - z_{i-1}},\text{ for } i = 2, \ldots P-1
$$

Using that, we can calculate the approximate $\D[z] v(z_i)$ for all $v \equiv \set{v(z_i)}_{i=1}^P$ with $L_1^{-} v$ and $\D[zz] v(z_i)$ for all $i$ as $L_2 v$.  Alternatively, combining the discretization of $A(t)$ in \cref{eq:simple-summary5-numerical} subject to the boundary conditions is then the $P \times P$ matrix
\begin{align}
A(t) &\equiv \left(r - \mu - \frac{\upsilon^2}{2}\right) I - (\mu + \upsilon^2 - g(t)) L^{-}_1 - \frac{\upsilon^2}{2} L_2, \label{eq:A-def-simple}
\end{align}
where $I$ is the identity matrix.

While non-binding in practice here, to check that the  $L^{-}_1$ backwards differences is the correct upwind direction, verify that\footnote{In the steady-state, this equation will be fulfilled for any non-degenerate solutions, but it is best to check this result at a few points in the transition path for off-BGP steps in the numerical algorithm.}
\begin{equation}
\mu + \sigma^2 - g(t) < 0.
\end{equation}



\paragraph{Quadrature}
In order to discretize \cref{eq:simple-summary2-numerical}, we need to calculate the integral using quadrature.  Since the grid points are already given (i.e., we can't choose Gaussian quadrature nodes), we use the weights for the non-uniform trapezoidal rule.

To calculate these, use $\Delta_{-}$ and $\Delta_{+}$ backwards and forward diffs (respectively) for the $z$ grid.  That is, $\Delta_{i,+} = z_{i+1} - z_i$ for $i = 0,\ldots P$, and $\Delta_{i,-} = z_i - z_{i-1}$ for $i = 1,\ldots P+1$.  Pad these with (with $\Delta_{0,-} = 0$ and $\Delta_{P+1,+} = 0$), so that from \cref{eq:Delta-minus,eq:Delta-plus}
\begin{align}
 	\Delta_{-} &\equiv \begin{bmatrix} 0 \\
	\text{diff}(z)
	\end{bmatrix}\in\R^{P+2}\\
	\Delta_{+} &\equiv \begin{bmatrix} \text{diff}(z)\\
	0
\end{bmatrix}\in\R^{P+2}.
\intertext{Define}
\bar{\omega}&\equiv \frac1{2}(\Delta_{-} + \Delta_{+})\in \R^{P+2}\\
\Xi_1 &\equiv \frac{1}{1 - \xi \Delta_{0,+}}\\
\Xi_P &\equiv \frac{1}{1 + \xi \Delta_{P+1,-}}.
\end{align}

Use \cref{eq:omega-i}, so that the rule only uses the interior values $v_1(t)$ to $v_P(t)$ and all other values are collapsed into constants (i.e., $e^z$ and the $F'(z)$) with $\bar{\omega}$ so that\footnote{It is important to remember that we are imposing the boundary conditions here in the calculation of the quadrature rules, so this approach would require adjustment with different boundaries (i.e., the $\Xi_1$ and $\Xi_P$ might be different).}
\begin{align}
\omega_i &\equiv\begin{cases}
\bar{\omega}_1 \frac{\theta e^{(\xi - \theta)z_1}}{1 - e^{-\theta \bar{z}}} + \bar{\omega}_0\Xi_1 \frac{\theta e^{(\xi - \theta)z_0}}{1 - e^{-\theta \bar{z}}}& \text{ for } i = 1\\
\bar{\omega}_i \frac{\theta e^{(\xi - \theta)z_i}}{1 - e^{-\theta \bar{z}}} & \text{ for } i = 2, \ldots P-1\\
\bar{\omega}_P \frac{\theta e^{(\xi - \theta)z_P}}{1 - e^{-\theta \bar{z}}} +  \bar{\omega}_{P+1}\Xi_P\frac{\theta e^{(\xi - \theta)z_{P+1}}}{1 - e^{-\theta \bar{z}}}& \text{ for } i = P
\end{cases}
\end{align}
% \frac{\theta e^{(\xi - \theta)z_0}}{1 - e^{-\theta \bar{z}}}

\noindent Using this definition, the integral is approximated by a linear operator $\omega\in\R^P$ applied to the solution of the PDE on the interior, i.e., $v(t)$.
\begin{align}
 \int_{0}^{\bar{z}}  v(z,t) \left(e^z \frac{F'(z)}{F(\bar{z})}\right) \diff z &\approx \omega \cdot v(t) .
\end{align}

\subsection{Discretized Model as an DAE}
Let $v_1(t)$ be the $1$st element in the $v(t)$ vector (i.e., the first value in the interior).  From \cref{sec:boundary-extrapolation}, we know that $v(0, t) = \Xi_1 v_1(t)$  Then value matching condition in \cref{eq:simple-summary2-numerical,eq:simple-summary1-numerical} along with the system of ODEs becomes the system of differential-algebraic equations (DAE)
\begin{align}
	v'(t) &= A(t) v(t) - \pi(t)\label{eq:discretized-simple}\\
	0 &= \Xi_1 v_1(t) - \omega \cdot v(t) + x(t) . \label{eq:discretized-simple-vm}
\end{align}


\noindent To find the stationary solution at $T$,  $v'(T) = 0$, we can solve the nonlinear system of equations
\begin{align}
	0 &= A(T; g) v(T) - \pi(T)\label{eq:discretized-simple-stationary}\\
	0 &= \Xi_1 v_1(T) - \omega \cdot v(T) + x(T) , \label{eq:discretized-simple-vm-stationary}
\end{align}
where the $ A(T; g)$ notation is to reinforce that it is the only component which is a function of $g$. This can be solved by using a nonlinear solver for $v(T)$ and $g$. This can also be solved by iterating on $g$: fix $g$, solve the linear \cref{eq:discretized-simple-stationary} for $v(T)$, check \cref{eq:discretized-simple-vm-stationary} for a non-zero residual, and update the guess of $g$ until convergence to a sufficiently small residual.

\subsection{Solving the Transition Dynamics}

Transition dynamics can be solved for any exogenous $x(t)$ and $\pi(z,t)$ functions defined on $t \in [0,\infty)$ where they remain constant after $T$.  The general approach  for this is to directly solve the system \cref{eq:discretized-simple,eq:discretized-simple-vm} as a DAE.\footnote{ We experimented extensively with the more typical method in the economics literature of guessing a path for $g(t)$, solving the discretized system as an ODE in \cref{eq:discretized-simple}, and then minimizing residuals of \cref{eq:discretized-simple-vm}.  For various reasons, this approach ended up being much slower and less stable for this particular problem, which led to the DAE solution.  While we were able to get solutions using the typical approach for the simple model, it failed to effectively solve the full model dynamics robustly.}

\begin{itemize}
	\item Choose an appropriate $z$ grid, with a large number of points close to $0$ as well as near the $\bar{z}$.\footnote{There is a degree of sensitivity in this model for the particular choice of $\bar{z}$ and the grid points for several reasons: (a) the imposition of the \cref{eq:simple-summary3-numerical} condition on $\D[z]v(0,t)$  is analytically the correct boundary condition of the optimal stopping problem for the imitation threshold--it comes from the smooth-pasting condition--but is sensitive to the precise curvature.  For this reason, the discretization needs to give it enough precision or the $g(t)$ can get distorted; (b) the majority of the curvature is close to the $z=0$ barrier, after which the function rapidly becomes constant; (c) the artificial boundary at $\bar{z}$ introduces a lot of curvature right near the end.  If there are not enough grid points close to the $\bar{z}$, then the local curvature near $v(\bar{z},t)$ effects a larger part of the whole distribution; and (d) since the expectation in \cref{eq:discretized-simple-vm} is taken over a heavy-tailed distribution, and is essential for solving the endogenous $g(t)$, truncations can have a significant bias if $\bar{z}$ is too small.  In particular, if you change the $\theta$ radically or conditions which lead to large changes in $g(t)$, you should verify that the analytical and numerical steady states do not become too different.}
	\item Identify an industrial-strength DAE solver (e.g., Sundials.jl in \url{http://docs.juliadiffeq.org/latest/tutorials/dae_example.html}).\footnote{See \cite{RackauckasNie2017} for more on the Julia ODE and DAE packages.  We use the SUNDIALS DAE solver from \cite{HindmarshBrownGrantEtAl2005}.}  To use these solvers, you provide an operator in the form of a stacked system of ODEs and algebraic equations, and then flag the algebraic ones for the solver.
	\item Find the time $T$ steady state as $v(T) \in \R^P$ and $g(T) \in R$ from \cref{eq:discretized-simple-stationary,eq:discretized-simple-vm-stationary} as the \textit{initial condition}, for working backwards in time.\footnote{While we have an analytical solution in this specific case, it is better to use the numerical solution for the steady-state since it is the steady-state of the DAE for a given grid.}
	\item Setup a function for equations \cref{eq:discretized-simple,eq:discretized-simple-vm}, tagging the last equation as an algebraic one.
	\item Solve the system, which is at most a medium-sized problem for a serious DAE solver.
\end{itemize}

This approach to solving transition dynamics seems to be generally applicable:\footnote{In fact, we suspect that this approach to be extremely fast and robust for most models.  Part of the difficulty in solving our setup is that models with endogenously determined growth rates have peculiarities which lead to extra sensitivity in numerical solutions.} (1) use a spatial discretization to turn the PDEs into a system of ODEs; (2) add any equilibrium constraints on the value functions or distributions as algebraic equations, using quadrature to convert any integrals into linear operators; (3) stack both to create a DAE system, and then use a high-performance solver.  A more general piece of advice for these is for economists to exploit high-performance ODE solvers with flexibility for various time-stepping methods rather than discretizing the time dimension on their own.

\section{Full Growth Model with Transition Dynamics}
The fundamental differences between solving the full model with transition dynamics and the simple model presented earlier are the following:
\begin{itemize}
	\item The $\pi(z,t)$ and $x(t)$ come from static equilibrium conditions given the trade-structure of the paper and the number of active local varieties, $\Omega(t)$, rather than being given exogenously
	\item The interest rate $r(t)$ is no longer given exogenously, but needs to be found in equilibrium.  Luckily, this is forward looking and can be solved in the current structure with only minor changes since the transition dynamics are being solved backwards
	\item The number of varieties $\Omega(t)$ is endogenously determined based on the endogenous entry decision, and may change slowly according to profit maximizing and income smoothing incentives
	\item There is an additional algebraic equation for the export threshold, $\hat{z}(t)$
\end{itemize}

\paragraph{General Algorithm}
Of these, the only significant change is that the $\Omega(t)$ must be solved separately since the entry decision is dynamic, forward-looking, and begins with a stock $\Omega(0)$.  Therefore, we cannot simply add it as a further algebraic equation.  In order to find the solution, we will need to guess a sequence of $\Omega(t)$ fulfilling the boundary conditions, solve the model, and iterate to convergence.

The iteration begins with an (irregular) grid of time-stops for a large terminal time $T$.  Instead of guessing the $\Omega(t)$ directly, we guess a sequence of $\hat{E}$ on all of the time-stops such that $\Omega(0) = \Omega_0$ and $\Omega(T) = \Omega_T$ when integrated, where the $\hat{E}$ are mapped to the $E$ and $\Omega$ through \cref{sec:entry-ODE}.

\begin{enumerate}
	\item Solve for the steady states for the time $0$ and time $T$ to find $\Omega_0, \Omega_T$, and the terminal solution for $v(T),\hat{z}(T),g(T)$
	\item Use the current $\hat{E}$ guess to solve for the $\Omega(t)$ function from \cref{sec:entry-ODE}.  This maps to a function such that the known boundary conditions $\Omega(0) = \Omega_0$ and $\Omega(T) = \Omega_T$ are fulfilled
	\item Solve the underlying DAE treating the $\Omega(t)$ as exogenous with the same basic algorithm as the simple model.
	\begin{itemize}
		\item The additional algebraic variables are $g, E, \hat{z}$ where the $E$ is used in all calculations instead of the guessed $\hat{E}$.  In particular, the $\hat{L}(t)$ calculation.
		\item The system becomes a DAE with: the ODE, the value-matching condition, the export threshold, and the free-entry condition  (i.e., of length $P + 3$).
	\end{itemize}
	\item Extract the $E(t)$ exactly at the time-stops used in the $\hat{E}$ guess from the DAE solution
	\item Convert the $E(t)$ to an implied $\hat{E}(t)$ by subtracting $\delta$ and then rescaling so that $\hat{E}(0) = -1$ and $\hat{E}(T) = 0$.
	\item This final step makes the process a fixed point in the $\hat{E}$ guess on the interior.
	\item Iterate the fixed point mapping with Anderson acceleration, and stop the iteration when $\hat{E}$ converges.
\end{enumerate}


\paragraph{Transition Dynamics Experiment}

Assume $\delta > 0$. The experiment is to examine a one-time unanticipated \textit{decrease} in $d$ as the trade liberalization.  We calculate the two steady states and examine the transition dynamics.

To evaluate the kernel of the DAE at a given $t$, we need to calculate $\tilde{\rho}(t), \pi_{\min}(t),\hat{z}(t),$ etc  as a function of $g(t), \hat{z}(t), \Omega(t),$ and parameters.  As a simplification, we will assume that the cost of adoption is in labor, i.e., $\eta = 0$, so that $x(t) = \zeta$ for all $t$ from (PTW H.11).\footnote{Otherwise, there is an addition system of implicit equations to solve.}  The other simplification will be to assume $\log$ utility, so that $\gamma = 1$, resulting in a slightly more manageable calculation of interest rates.

\subsection{Static Calculations and Definitions}
Let $E(t)\Omega(t)$ be the associated gross entry flow at time $t$ and $\Omega(t)$ the number of varieties.  Then use a given $g(t), \hat{z}(t),$ and  $\tilde{L}(t+\Delta_t)$ for some small $\Delta_t$ to calculate the static equilibrium conditions,\footnote{See \cref{sec:derive-interest-rates} for a derivation of the interest rates, and \cref{sec:full-rescaling} for a derivation of the normalized profits.}${}^{,}$.\footnote{Note: the $\hat{z}(t)$ is not taken with a $\log$, unlike the $z$.  Hence, to see if a firm exports, we need to check if $z \geq \log(\hat{z}(t))$.  Furthermore, it means that the $\hat{z}$ has a minimum value of $1$.  This decision was taken simply to make comparison to the main paper algebra clearer.}
\begin{align}
	S(t) &\equiv \theta \left( g(t) - \mu - \theta\frac{\upsilon^2}{2}\right)\\
	1 - \tilde{L}(t) &\equiv 1 - \Omega(t)\left((N -1)\hat{z}^{-\theta}\kappa + \zeta \left(S(t) + E(t)/\chi \right)\right)\\
	\tilde{L}_{\text{x}}(t) &= \Omega(t) (N -1)\hat{z}^{-\theta}\kappa\\
	\tilde{L}_{\text{E}}(t) &= \frac{\zeta}{\chi}\Omega(t) E(t)\\
	\tilde{L}_{\text{a}}(t) &= \zeta \Omega(t) S(t)\\
	\bar{z}(t)&\equiv \left(\Omega(t)
\frac{\theta}{1+\theta - \sigma}\left(1 + (N-1)d^{1-\sigma}\hat{z}^{\sigma - 1 -\theta} \right)\right)^{\frac{1}{\sigma - 1}}\\
	\bar{\pi}_{\min}(t) &\equiv \frac{1-\tilde{L}(t)}{(\sigma-1)\bar{z}(t)^{\sigma-1}}\\
	\pi(z,t) &\equiv \bar{\pi}_{\min}(t)\left(1 + (N-1)d^{1-\sigma}\indicator{z \geq \log(\hat{z}(t))}\right) - (N-1)\kappa e^{-(\sigma - 1)z}\indicator{z \geq \log(\hat{z}(t))}\\
	\tilde{\rho}(t) &\equiv \underbrace{\rho+ \delta + \D[t]\log\left(1 - \tilde{L}(t)\right)}_{\equiv \tilde{r}(t)} - (\sigma - 1)\left(\mu - g(t) + (\sigma - 1)\frac{\upsilon^2}{2} \right).
\end{align}
To calculate the $\D[t]\log\left(1 - \tilde{L}(t)\right)$ we need to reference the ``future'' $\tilde{L}(t+\Delta_t)$. That is,
\begin{align}
	\D[t]\log\left(1 - \tilde{L}(t)\right) &\approx \frac{\log\left(1 - \tilde{L}(t+\Delta_t)\right) - \log\left(1 - \tilde{L}(t)\right)}{\Delta_t},
\end{align}
where the $\Delta_t$ is that periods (potentially adaptive) step-size in the time-stepping algorithm of the DAE solver.  Since the algorithm solves the transition dynamics backwards, this can be done using the previous (i.e., future) timestep, and then forward first-differences for a given $\tilde{L}(t)$.   Alternatively, given a sequence of $\tilde{L}(t)$, it can be calculated afterwards as part of an iterative step.


\subsection{Number of Varieties and Entry in Transition}\label{sec:entry-ODE}


When making a guess for the varieties over the transition path, in principle we could have chosen either the $\Omega(t)$ or the $E(t)$ (for $t \in [0,T]$) and converted between them using \cref{eq:E-defined-by-Omega}.\footnote{In practice, though, the model does not solve effectively with guesses on $\Omega(t)$ since small changes in the guess can lead to large deviations in $E(t)$, which enter the growth calculations directly.}  Analytically, we know that any guess for $E(t)$ on $t \in [0,T]$ is one where $E(T) = \delta$ and where $\Omega(T) = \Omega_T$ from the new steady state.  Since choosing a guess on an $E(t)$ which fulfills these conditions is difficult, we instead do the change of variables to guess a $\widehat{E}(t)$ such that $\widehat{E}(T) = 0$, where $\widehat{E}(0)$ is \textit{indeterminate} and can be rescaled.  See \cref{sec:Omega-E} for the detailed derivation.

Given the guess on $\widehat{E}(t)$, and assuming that $\widehat{E}(t)$ is not $0$ throughout, first calculate the scaling constant\footnote{In the case of checking if the model solves transition dynamics without solutions (i.e., when $E(t) = \delta$ is the solution), this assumption is not an issue due to the indeterminancy.  As long as there is any guess other than flat, $Q = 0$ comes out as the scaling factor, which solves the solution perfectly.}

\begin{align}
	Q &= \log \left(\dfrac{\Omega_T}{\Omega_0}\right)\left(\int_0^T \widehat E(t) dt \right)^{-1} . \\
	\intertext{Then map to the $E(t)$ and $\Omega(t)$ with the following equation and differential equation}
	E(t) &= Q \widehat{E}(t) + \delta\\
	\D[t] \Omega(t) &= Q \widehat{E}(t) \Omega(t).
\end{align}

In practice, since the guess $\widehat{E}(0)$ is arbitrary and simply changes the scale of $Q$ used to map to $E(t)$, it will be helpful to set it to a single number between iterations.  Here we maintain $\widehat{E}(0) = - 1$ at each iteration.

\subsection{DAE for the Full Solution}\label{sec:full-ODE}
The dynamic set of differential equations (rescaled) is derived in \cref{sec:full-model-derivations} and is very similar to the simple model.
\begin{align}
	\D[t]v(z,t) &= A(t)v(z,t) - \pi(z,t) \\
	A(t) &\equiv \tilde{\rho}(t)  - (\mu - g(t) + (\sigma - 1)\upsilon^2)\D[z] - \frac{\upsilon^2}{2}\D[zz]\\
	v(0,t) &= \int_{0}^{\bar{z}}v(z,t) \frac{e^{\sigma - 1}F'(z)}{F(\bar{z})} \diff z - \zeta\\
	0 &= (\sigma - 1)v(0,t) + \D[z]v(0,t)\\
	0 &= (\sigma - 1)v(\bar{z},t) + \D[z]v(\bar{z},t)
	\intertext{With the export threshold}
	0&=\hat{z}(t)^{\sigma-1}-  \kappa d^{\sigma - 1} \bar{\pi}_{\min}(t)^{-1}
	\intertext{And free-entry condition}
	0 &= v(0,t)- \zeta \frac{1-\chi}{\chi},\quad\text{ if } E(t) > 0
\end{align}

As described in the solution to the simple model, when the normalization is undone, the artificial $\bar{z}$ boundary used for the discretization is growing at the same speed as the economy and does create a fixed finite-support which would prevent long-run growth.


\subsection{Dynamic Equations and Discretization}
To discretize the DAE system presented in \cref{sec:full-ODE}, define the operator, in a way similar to \cref{eq:A-def-simple}
\begin{align}
	A(t) &\equiv \tilde{\rho}(t) I - (\mu - g(t) + (\sigma - 1)\upsilon^2) L^{-}_1 - \frac{\upsilon^2}{2} L_2 . \label{eq:A-def-full}
	\end{align}
As before, this operator implement the boundary conditions in the discretized operator to get the system of ODEs,
\begin{align}
	v'(t) &= A(t) v(t) - \pi(t).
\end{align}

The three algebraic variables required in the DAE are $g(t), \hat{z}(t),$ and $\Omega(t)$. The \cref{eq:normalized-vm-summary-rescaled} value matching equation uses the same discretization approach as in the simple example (combining everything into the weights $\omega$, with the truncated exponential distribution, etc.)
\begin{align}
	0 &= \Xi_1 v_1(t) - \omega \cdot v(t) + \zeta .
	\intertext{The export threshold equation is}
	0&=\hat{z}(t)^{\sigma-1}-  \kappa d^{\sigma - 1} \bar{\pi}_{\min}(t)^{-1} .
	\intertext{From \cref{sec:free-entry}, we see that the free-entry condition is}
	\Xi_1 v_1(t) -  \zeta \frac{1-\chi}{\chi} &\leq 0,\, = 0 \text{ if } E(t) > 0 .
\end{align}




\paragraph{Final Calculations}
Some additional calculations useful for analyzing the model, but not required for the intermediate calculations are
\begin{align}
	\lambda_{ii}(t) &= \frac{1}{1 + (N-1)\hat{z}(t)^{\sigma-1-\theta}d^{1-\sigma}}\label{eq:lambda-ii-t-summary}\\
c(t) &= (1 - \tilde{L}(t))\bar{z}(t) \label{eq:c-summary}\\
\log M(t) &= \int_0^t g(s)\diff s\label{eq:log-M-summary}\\
U(t) &= \int_0^{T-t}e^{-\rho \tau}\left(\log M(t+\tau)+\log c(t+\tau)\right)\diff \tau + \frac{e^{-\rho( T-t)}}{\rho^2}\left((1+\rho( T-t))g(T) + \rho\left(\log c(T) + \log M(T) \right) \right)\label{eq:U-dynamics-summary}\\
\bar{\pi}_{\text{rat}}(t) &= \theta\frac{1 - \hat{z}(t)^{-\theta + \sigma - 1}}{\theta - \sigma + 1} + (1 + (N-1)d^{1-\sigma})\theta\frac{\hat{z}(t)^{-\theta + \sigma - 1}}{\theta - \sigma + 1} + (N-1)\frac{\kappa}{\bar{\pi}_{\min}(t)} \hat{z}(t)^{-\theta}\label{eq:pi_rat-dynamics-summary}\\
&= \notag \frac{\theta}{1 + \theta - \sigma} + (N-1)d^{1-\sigma}\frac{(\sigma-1)\hat{z}^{\sigma-1-\theta}}{1 + \theta - \sigma}
\intertext{The calculation of the consumption equivalent ratio, useful to compare the $U(0)$ from above to an alternative $U^{\text{old}}(0))$ is}
M_{\text{CE}} &= \exp \left(\rho(U(0) - U^{\text{old}}(0))\right) .
\end{align}
In the above cases, given the interpolated solutions of the problem, we can use any quadrature method, including pre-built libraries, to calculate the integrals since they are only evaluated after the rest of the solution is complete.


\newpage
\appendix
\makeatletter
\def\@seccntformat#1{Appendix\ \csname the#1\endcsname\quad}
\makeatother
\makeatletter
\def\@seccntformat#1{\csname Pref@#1\endcsname \csname the#1\endcsname\quad}
\def\Pref@section{Appendix~}
\makeatother
\numberwithin{equation}{section}
%\let\normalsize\small
%\small

\section{Discretization}
\subsection{Spatial Discretization}\label{sec:discretization}
This will discretize space with backward differences in the first derivative, and central in space for the 2nd derivative.\footnote{Under a $g(t) > \gamma$ assumption (which may be a general requirement on parameter restrictions), the drift is negative, and the correct ``upwind'' finite difference scheme is always backwards.}  After discretizing the spatial dimension, we have a system of ODEs in time - which are solved using various time-stepping algorithms.

\begin{itemize}
	\item Define an irregular  grid $\set{z_i}_{i=0}^{P+1}$ with $z_0 = 0$ and $z_{P+1} = \bar{z}$ is a ``large'' number (keeping in mind that the effective number is $e^{\bar{z}}$).  After discretizing, we will denote the grid with the variable name, i.e., $z \equiv \set{z_i}_{i=0}^{P+1}$.
	\item Denote the distance between the grid points as the \textit{backwards} and \textit{forwards} difference respectively
	\begin{align}
	\Delta_{i,-} &\equiv z_i - z_{i-1},\, \text{for } i = 1,\ldots, P+1\\
	\Delta_{i,+} &\equiv z_{i+1} - z_i,\, \text{for } i = 0,\ldots, P
	\end{align}
	\item Define the vector of backwards and forwards first differences (padding with $0$s) as
	\begin{align}
	\Delta_{-} &\equiv \begin{bmatrix} 0 \\
	\text{diff}(z)
	\end{bmatrix}\in\R^{P+2}\label{eq:Delta-minus}\\
	\Delta_{+} &\equiv \begin{bmatrix} \text{diff}(z)\\
	0
	\end{bmatrix}\in\R^{P+2}
	\end{align}\label{eq:Delta-plus}
	\item The grid on time $t \in [0,T]$ may be adaptive, and we will let the ODE solver handle the grid in order to use optimal time-stepping algorithms.
	\item Denote time-varying functions on the grid as a vector without the spatial dimension (on the interior of the domain), i.e.,
	\begin{align}
	v(t) &\equiv \set{v(z_i, t)}_{i=1}^P\in\R^P\\
	\hat{\pi}(t) &\equiv	\hat{\pi}(z,t) \in \R^P
	\end{align}
\end{itemize}

\subsection{Boundary Extrapolation}\label{sec:boundary-extrapolation}
Note in the above definition, $v(t) \in \R^P$ and hence is not evaluated at the boundaries.  In the case of boundary points in the discretized model, define $v_0(t) \equiv v(z_0, t)$ and $v_{P+1}(t) \equiv v(z_{P+1},t)$.

Given a solution for $v(t)$, we can extrapolate to find the function at the boundaries $v_0(t)$ and $v_{P+1}(t)$ by using the boundary conditions from the PDE.  In the case of the boundary conditions in \cref{eq:new-BC1,eq:new-BC2}, substitute in the first differences (forward and backwards, respectively) and use the $z$ grid

\begin{align}
	\xi v(z_0, t) + \frac{v(z_1,t) - v(z_0,t)}{z_1 - z_0} &= 0\\
	\xi v(z_{P+1},t) + \frac{v(z_{P+1},t) - v(z_P,t)}{z_{P+1} - z_P} &= 0
\end{align}
Rearrange and use definitions of the vectors to find expressions for the extrapolation as linear functions of the interior nodes
\begin{align}
	v_0(t) &= \Xi_1 v_1(t) \label{eq:v0-1-bc}\\
	v_{P+1}(t) &=  \Xi_P v_P(t)\label{eq:vP-P1-bc}
	\intertext{Where,}
	\Xi_1 &\equiv \frac{1}{1 - \xi \Delta_{0,+}}\\
	\Xi_P &\equiv \frac{1}{1 + \xi \Delta_{P+1,-}}
\end{align}


\subsection{Discretized Operators}\label{sec:discretized-operators}
For completeness: From \url{https://github.com/QuantEcon/SimpleDifferentialOperators.jl/releases/download/dev/discretized-differential-operator-derivation.pdf} the discretizations for first and second derivatives with the irregular grid are (where $\underline{\xi}  = \bar{\xi}  = \sigma - 1$)
\begin{align}
	L_{1}^- &\equiv \begin{psmallmatrix}
	\Delta_{1,-}^{-1} [1 + (-1 + \underline{\xi} \Delta_{1,-})]^{-1} &0&0&\dots&0&0&0\\
	-\Delta_{2,-}^{-1}&\Delta_{2,-}^{-1}&0&\dots&0&0&0\\
	\vdots&\vdots&\vdots&\ddots&\vdots&\vdots&\vdots\\
	0&0&0&\dots&-\Delta_{P-1,-}^{-1}&\Delta_{P-1,-}^{-1}&0\\
	0&0&0&\cdots&0&-\Delta_{P,-}^{-1}&\Delta_{P,-}^{-1}
	\end{psmallmatrix}\\
	L_2 &\equiv 2 \begin{psmallmatrix}
	\Xi_1 &
	(\Delta_{1,+}+\Delta_{1,-})^{-1} \Delta_{1,+}^{-1}
	&0&\cdots&0&0&0 \\
	\vdots&\ddots&\ddots&\ddots&\ddots&\vdots&\vdots\\
	0&\cdots&
	(\Delta_{i,+}+\Delta_{i,-})^{-1} \Delta_{i,-}^{-1} &
	-\Delta_{i,-}^{-1} \Delta_{i,+}^{-1}  &
	 (\Delta_{i,+}+\Delta_{i,-})^{-1} \Delta_{i,+}^{-1}&\cdots&0 \\
	\vdots&\vdots&\vdots&\ddots&\ddots&\ddots&\vdots\\
	0&0&0&\cdots&0&(\Delta_{P,+}+\Delta_{P,-})^{-1} \Delta_{P,-}^{-1}&\Xi_P
	\end{psmallmatrix}
	\intertext{where,}
	\Xi_{1} &\equiv - (-1 + \underline{\xi} \Delta_{1,-})^{-1} (\Delta_{1,+} + \Delta_{1,-})^{-1}  \Delta_{1,-}^{-1} \\
	\Xi_{P} &\equiv  (1 + \bar{\xi} \Delta_{P,+})^{-1} (\Delta_{P,+} + \Delta_{P,-})^{-1}  \Delta_{P,+}^{-1}
\end{align}


\section{Derivations for Simple Model}\label{sec:simple-derivation}
\subsection{Equations Prior to Rescaling}

From the technical appendix of \cite{BenhabibPerlaTonetti2017} (but renaming the $v$ function to be $\hat{v}$ here to avoid confusion with our normalization), assume an exogenously given $\hat{\pi}(z,t)$ and $x(t)$ function.  We will only look at examples where $F(z) = 1 - e^{-\theta z}$ for all $t$.
\begin{align}
(r - g(t)) \hat{v}(z,t) &= \hat{\pi}(z,t) + (\mu- g(t)) \D[z] \hat{v}(z,t) + \frac{\upsilon^2}{2} \D[zz] \hat{v}(z,t) + \D[t]\hat{v}(z,t)\label{eq:bellman-GBM-dynamic}	\\
\hat{v}(0,t) &= \int_{0}^{\infty} \hat{v}(z,t) F'(z)\diff z - x(t)\label{eq:vm-GBM-dynamic}\\
\D[z]\hat{v}(0,t) &= 0\label{eq:sp-GBM-dynamic}
\end{align}

A solution to this problem is a $g(t)$ and $\hat{v}(z,t)$ that fulfills the above equations for all $t\in[0,T]$ and $z\in[0,\infty)$.  While not listed above, in practice another boundary condition (e.g. transversality) is used to ensure that \cref{eq:bellman-GBM-dynamic} can be solved. For this problem, an artificial reflecting barrier at a ``large'' $\bar{z}$ converges to the correct solution.  Again, keep in mind that for the pre-normalized solution, this artificial threshold is growing with the economy, and does not actually impose a bounded distribution (i.e., $\bar{Z}(t) = M(t) e^{\bar{z}}$).

Use the boundary value\footnote{Keep in mind that this is just a step in the numerical solution, rather than introducing a true reflecting barrier.  We will need to verify that it does not introduce issues by verifying the numeric solution matches the closed form solution for large $\bar{z}$ and compare to the analytic equation for external validity.  Also note that if $\upsilon = 0$, due to the upwind procedure this boundary value would be unnecessary and/or drop out of the solution.}
	\begin{align}
	\D[z]\hat{v}(\bar{z},t) &= 0\label{eq:reflecting-GBM-dynamic}
	\end{align}


\subsection{Change of Variables to Normalize and Rescale}\label{eq:simple-rescale}
Solving \cref{eq:bellman-GBM-dynamic} for $\hat{v}(z,t)$ on a grid is problematic since the scale goes from approximately $1$ to $e^{\bar{z}}$, which is very large for a high $\bar{z}$.  To make the solution more stable, we rescale the equation.  Choose some $\xi \geq 0$ for convenience and to ensure stability and let
\begin{align}
	v(z,t) &\equiv e^{-\xi z}\hat{v}(z,t) = e^{-\xi z}\frac{V(e^z M(t),t)}{M(t)}\\
	\intertext{Differentiate and reorganize this expression to yield}
	\D[z]\hat{v}(z,t) &= e^{\xi z}\left(\xi v(z,t) + \D[z]v(z,t) \right)\\
	\D[zz]\hat{v}(z,t) &= e^{\xi z}\left(\xi^{2} v(z,t) + 2 \xi\D[z]v(z,t) + \D[zz]v(z,t)  \right)\\
	\D[t]\hat{v}(z,t) &= e^{\xi z} \D[t]v(z,t)
\end{align}
Define $\pi(z,t) = e^{-\xi z}\hat{\pi}(z,t)$ so that if $\hat{\pi}(z,t) = e^{\xi z}$ then $\pi(z,t) = 1$.  Substitute into \cref{eq:bellman-GBM-dynamic}, divide by $e^{\xi z}$ and simplify,

\begin{align}
	\left(r - g(t)- \xi(\mu-g(t)) - \frac{\upsilon^2}{2}\xi^2\right)  v(z,t) &= \pi(z,t) + (\mu+ \upsilon^2\xi - g(t)) \D[z]v(z,t) \nonumber \\ &+ \frac{\upsilon^2}{2} \D[zz]v(z,t) + \D[t]v(z,t)  \label{eq:bellman-GBM-dynamic-normalized}
\end{align}

\noindent Now, substitute into the boundary conditions \cref{eq:sp-GBM-dynamic,eq:reflecting-GBM-dynamic} to find,
\begin{align}
	\xi v(0,t) + \D[z]v(0,t ) &= 0\label{eq:new-BC1}\\
	\xi v(\bar{z},t) + \D[z]v(\bar{z},t) &= 0\label{eq:new-BC2}
\end{align}
Finally, in the value matching condition, $\hat{v}(0,t) = e^{0} v(0,t)$ where if the $F'(z) = \theta e^{-\theta z}$ then,
\begin{align}
	 v(0,t) &= \int_{0}^{\infty}  v(z,t) \left(e^{\xi z} F'(z)\right) \diff z - x(t)\label{eq:vm-GBM-dynamic-normalized-not-truncated}
\end{align}
However, for the numerical approximation with the artificial boundary at $\bar{z}$, we need to use a truncated distribution for $F(z)$.  Since the support of $F(z)$ is $[0,\infty)$, and we truncate at $\bar{z} = \bar{z}$ then the equation in \cref{eq:vm-GBM-dynamic-normalized-not-truncated} becomes
\begin{align}
	 v(0,t) &= \int_{0}^{\bar{z}}  v(z,t) \left(e^{\xi z} \frac{F'(z)}{F(\bar{z})}\right) \diff z - x(t)\label{eq:vm-GBM-dynamic-normalized}
\end{align}


\subsection{Quadrature}\label{sec:quadrature}
With the discretized grid, the integral in \cref{eq:vm-GBM-dynamic-normalized} will be calculated with some quadrature rules.\footnote{An issue here is that the support of the integral is infinite, but the finite differences go to $\bar{z}$.  While not ideal, since $F'(\bar{z})\to 0$ rapidly, the Trapezoidal rule should be a  reasonable approximation.}  Recall that with a grid on $z$ we have that $z_0 \equiv 0$ and $z_{P+1} \equiv \bar{z}$.  Define Let $q \equiv \set{q(z_i)}_{i=0}^{P+1}$ for some function $q(\cdot)$, then a quadrature rule are weights $\bar{\omega} \in \R^{P+2}$ such that
\begin{align}
\int_0^{\bar{z}} q(z) \diff z &\approx \bar{\omega} \cdot q
\intertext{To derive the non-uniform trapezoidal rules for an arbitrary $q$ function,}
\int_{0}^{\bar{z}} q(z)\diff z &\approx \frac{1}{2}\sum_{i=0}^{P}(z_{i+1}-z_i)(q(z_i) + q(z_{i+1}))\\
\intertext{Use the forward difference $\Delta_{i,+} \equiv z_{i+1} - z_i$, and rearrange}
&= \frac1{2}\left((0 + \Delta_{0,+})q(z_0) + (\Delta_{0,+} + \Delta_{1,+})q(z_1) + \ldots (\Delta_{P-1,+} + \Delta_{P,+})q(z_{P})+(\Delta_{P,+} + 0)q(z_{P+1})\right)
\intertext{Since $\Delta_{i,+} = \Delta_{i+1,-}$ for all $i = 1, \ldots P$}
&= \frac1{2}\left((0 + \Delta_{0,+})q(z_0) + (\Delta_{1,-} + \Delta_{1,+})q(z_1) + \ldots (\Delta_{P,-} + \Delta_{P,+})q(z_{P})+(\Delta_{P+1,-} + 0)q(z_{P+1})\right)
\end{align}
Finally, use the $\Delta_{-}$ and $\Delta_{+}$ as defined from \cref{eq:Delta-minus,eq:Delta-plus} (note the use of a padding $0$ in those definitions) and group to find
\begin{align}
\int_{0}^{\bar{z}} q(z)\diff z &\approx \bar{\omega}\cdot q\\
\intertext{Where,}
\bar{\omega}&\equiv \frac1{2}(\Delta_{-} + \Delta_{+})\in\R^{P+2}\\
\intertext{Moving to the specific integral in \cref{eq:vm-GBM-dynamic-normalized},}
\int_{0}^{\bar{z}}  v(z,t) \left(e^{\xi z} \frac{F'(z)}{F(\bar{z})}\right) \diff z &\approx \sum_{i=0}^{P+1} \bar{\omega}_i e^{\xi z_i}\frac{F'(z_i)}{F(\bar{z})}v(z_i,t)
\intertext{With this, define the $\omega \in R^P$ weights to combine the $\bar{\omega}$ and the $\left(e^{\xi z} \frac{F'(z)}{F(\bar{z})}\right)$ terms, and use \cref{eq:vP-P1-bc,eq:v0-1-bc} so that}
\omega_i &\equiv\begin{cases}
\Xi_1\bar{\omega}_0 e^{\xi z_0}\frac{F'(z_0)}{F(\bar{z})} + \bar{\omega}_1 e^{\xi z_1}\frac{F'(z_1)}{F(\bar{z})} & \text{ for } i = 1\\
\bar{\omega}_i e^{\xi z_i}\frac{F'(z_i)}{F(\bar{z})} & \text{ for } i = 2, \ldots P-1\\
\bar{\omega}_P e^{\xi z_P}\frac{F'(z_P)}{F(\bar{z})} +  \Xi_P\bar{\omega}_{P+1} e^{\xi z_{P+1}}\frac{F'(z_{P+1})}{F(\bar{z})}& \text{ for } i = P
\end{cases}\label{eq:omega-i}
\intertext{Then with the discretized vector $v(t) \in \R^P$, the integral in \cref{eq:vm-GBM-dynamic-normalized} becomes,}
\Xi_1 v_1(t) &= \omega \cdot v(t) - x(t)
\end{align}


\section{Derivations of Full Model}\label{sec:full-model-derivations}

\subsection{Static Objects and Algebraic Solution}\label{sec:full-algebraic-solution}

Note that we have the following static calculations from PTW (H.1) to (H.11)

\begin{align}
	F(z) &= 1 - z^{-\theta} \\
	S &= \theta \left(g - \mu - \theta \frac{\upsilon^2}{2}\right) \\
	\nu &\equiv  \frac{\mu- g}{\upsilon^2} + \sqrt{\left(\frac{g-\mu}{\upsilon^2} \right)^{2} + \frac{r-g}{\upsilon^2/2}}\\
	a &= \frac{1}{r - g - (\sigma - 1)(\mu - g  + (\sigma - 1)\upsilon^2/2)} \\
	b &= (1 - a(r-g))d^{1-\sigma}\hat{z}^{\nu + \sigma -1} \\
	r &= \rho + \gamma g + \delta \\
	\tilde{L} &= \Omega [(N-1)\hat{z}^{-\theta}\kappa + (1-\eta)\zeta(S + \delta/\chi)] \\
	\tilde{L}_{\text{x}} &= \Omega (N -1)\hat{z}^{-\theta}\kappa\\
	\tilde{L}_{\text{E}} &= \frac{\zeta}{\chi}\Omega\delta\\
	\tilde{L}_{\text{a}} &= \zeta \Omega S\\
%	\bar{z} &= [\Omega(\mathbb{E}[z^{\sigma - 1}] + (N-1)(1 - F(\hat{z}))d^{1 - \sigma}\mathbb{E}[z^{\sigma - 1}|z > \hat{z}])]^{1/(\sigma - 1)} \\
	\bar{z}&\equiv \left[\Omega
	\frac{\theta}{1+\theta - \sigma}\left(1 + (N-1)d^{1-\sigma}\hat{z}^{\sigma - 1 -\theta} \right)\right]^{1/(\sigma - 1)} \\
	\hat{z} &= d \left(\frac{\kappa}{\bar{\pi}_{\textup{min}}}\right)^{\frac{1}{\sigma - 1}} \\
	w &= \frac{\sigma - 1}{\sigma}\bar{z} \\
	x &= \zeta(1 - \eta + \eta \Theta / w) \\
		c &= (1 - \tilde{L})\bar{z} \\
		\bar{U} &=
	\begin{cases}
	\frac{\rho \log(c) + g}{\rho^2}, & \gamma = 1 \\
	\frac{1}{1-\gamma} \frac{c^{1 - \gamma}}{\rho + (\gamma - 1)g} & \text{otherwise}
	\end{cases}
\end{align}

Note also that the following formula for the ratio of aggregate to minimum profits, PTW (31), holds in steady state:

\begin{equation}
	\bar{\pi}_{\text{rat}} \equiv \frac{\left(\theta + (N-1)(\sigma-1)d^{-\theta}\big(\frac{\kappa}{\zeta} \frac{\chi}{\rho (1-\chi)}\big)^{1 - \frac{\theta}{\sigma - 1}}\right)}{1 + \theta - \sigma}
\end{equation}

Or:

\begin{equation*}
\bar{\pi}_{\text{rat}} = \frac{\theta}{1 + \theta - \sigma} + (N-1)d^{1-\sigma}\frac{(\sigma-1)\hat{z}^{\sigma-1-\theta}}{1 + \theta - \sigma}
\end{equation*}

The above gives us a system of three nonlinear equations to solve:

		\begin{align}
		\frac{x}{\bar{\pi}_{\min}} &=  a \frac{\chi}{1-\chi}\frac{\sigma + \nu - 1}{\nu} , \\
		1 + \frac{\sigma - 1}{\nu} &= {\scriptstyle \frac{\frac{\nu  (n-1) (\theta -\sigma +1) \left(d^{1-\sigma } (\theta +\nu ) \hat{z}^{-\theta +\sigma -1}-b \theta  \hat{z}^{-\theta -\nu }\right)}{a (g-r)}+\theta  \left(\nu  (n-1) d^{1-\sigma } (\theta +\nu ) \hat{z}^{-\theta +\sigma -1}+(\nu +\sigma -1) (\theta +\nu -\sigma +1)\right)}{\nu  (\theta +\nu ) (\theta -\sigma +1)} -  \frac{\chi}{1-\chi}\frac{\sigma + \nu - 1}{\nu}} , \\
		\bar{\pi}_{\min} &= \tfrac{1 - \tilde{L}}{(\sigma - 1) \bar{z}^{\sigma - 1}}.
		\end{align}

\subsection{Normalization and Rescaling}\label{sec:full-rescaling}
Note: unlike the main paper we have $z \equiv \log(Z/M(t))$ throughout these notes.  The value is normalized as $\hat{v}(z,t) = \frac{V(e^z M(t),t)}{M(t)w(t)}$.  With this,
\begin{align}
V(Z,t) &:= w(t) M(t) \hat{v}(t, \log(Z/M(t)))\label{eq:V-norm}\\
\intertext{Differentiate \cref{eq:V-norm} with respect to $t$, divide by $w(t)M(t)$, and use the definitions $z := \log(Z/M(t)), g(t):= M'(t)/M(t)$ and $g_w(t) := W'(t)/W(t)$}
\frac{1}{w(t) M(t)}\D[t]V(Z,t) &= \left(g(t) + g_w(t)\right)\hat{v}(z,t) - g(t)\D[z]\hat{v}(z,t) + \D[t]\hat{v}(z,t) \label{eq:dV-dt}\\
\intertext{Similarly, differentiate \cref{eq:V-norm} with respect to $Z$,}
\frac{1}{w(t) M(t)}\D[Z]V(Z,t) &= \frac{1}{Z}\D[z]\hat{v}(z,t)\label{eq:dV-dZ}\\
\frac{1}{w(t) M(t)}\D[ZZ]V(Z,t) &= \frac{1}{Z^2}\left(\D[zz]\hat{v}(z,t)-\D[z]\hat{v}(z,t)\right)\label{eq:dV-dZZ}
\end{align}
Take the unnormalized Bellman equation from the paper, repeated below,
\begin{align}
r(t) V(Z,t) &=  \Pi(Z,t)+ \left(\mu + \frac{\upsilon^2}{2}\right) Z\, \D[Z]V(Z,t)+ \frac{\upsilon^2}{2} Z^2 \D[ZZ]V(Z,t) +  \D[t]V(Z,t), \label{ap-eq:bellman-deterministic-prenorm}
\intertext{Use $\pi(z,t) \equiv \frac{\Pi(Z,t)}{w(t)M(t)}$ with the new $z$, divide \cref{ap-eq:bellman-deterministic-prenorm} by $w(t)M(t)$ and then use \cref{eq:dV-dt,eq:dV-dZ,eq:dV-dZZ} to find,}
(r(t) - g(t) - g_w(t))\hat{v}(z,t) &= \pi(z,t) + (\mu - g(t))\D[z]\hat{v}(z,t) + \frac{\upsilon^2}{2}\D[zz]\hat{v}(z,t) + \D[t]\hat{v}(z,t)\label{eq:normalized-bellman}
\intertext{The smooth pasting condition, $\D[Z]V(M(t),t) = 0$ becomes}
\D[z]\hat{v}(0,t) &= 0\label{eq:normalized-sp}
\intertext{Take the value matching condition from the paper and divide by $M(t)w(t)$,}
\frac{{V}(M(t),t)}{M(t)w(t)} &= \int_{M(t)}^{\infty}\frac{{V}(Z,t)}{M(t)w(t)} \phi(Z,t) \diff Z - \frac{X(t)}{M(t)w(t)}
\intertext{Substitute for $\hat{v}(z,t)$ and $x(t) \equiv \frac{X(t)}{M(t)w(t)}$,}
\hat{v}(0,t) &= \int_{0}^{\infty}\hat{v}(\log(Z/M(t)),t) \phi(Z,t) \diff Z - x(t)
\intertext{With a change of variables in the integral to  $z = \log(Z/M(t))$,}
\hat{v}(0,t) &= \int_{0}^{\infty}\hat{v}(z,t) f(z,t) \diff z - x(t)\label{eq:normalized-vm}
\intertext{We will only solve versions of the model starting from the steady-state normalized distribution of the GBM process, which is a Pareto distribution with tail index $\theta$ and minimum $M(t)$.  If $\phi(Z,t) = \theta M(t)^{\theta}Z^{-(1+\theta)}$ then}
f(z) &= \theta e^{-\theta z}\label{eq:f-stationary}
\end{align}
for all $t$.  It can be proven that this will be maintained by the KFE in the setup for any $g(t)$ sequence.

While this transformation could be done all at once, we will base it off of the previous section for easier comparison.  Define the following
\begin{align}
v(z,t) &\equiv e^{-(\sigma - 1)z}\hat{v}(z,t)\label{eq:v-tilde}\\
\pi(z,t) &\equiv e^{-(\sigma - 1)z}\hat{\pi}(z,t)
\end{align}
Rearrange and differentiate \cref{eq:v-tilde},
\begin{align}
\D[t]\hat{v}(z,t) &= e^{(\sigma - 1)z} \D[t]v(z,t)\label{eq:v-tilde-dt}\\
\D[z]\hat{v}(z,t) &= e^{(\sigma - 1)z}\left((\sigma - 1) v(z,t) + \D[z]v(z,t) \right)\label{eq:v-tilde-dz}\\
\D[zz]\hat{v}(z,t) &= e^{(\sigma - 1)z}\left((\sigma - 1)^2 v(z,t) + 2(\sigma - 1)\D[z]v(z,t) + \D[zz]v(z,t)\right)\label{eq:v-tilde-dzz}\\
\intertext{And at the adoption threshold, from \cref{eq:v-tilde-dz}}
\D[z]\hat{v}(0,t) &= (\sigma - 1) v(0,t) + \D[z]v(0,t)\label{eq:vt-0-dz}
\end{align}

\noindent To use these substitutions, start with \cref{eq:normalized-vm} and use the definition of $f(z)$,
\begin{align}
v(0,t) &= \theta \int_{0}^{\infty} v(z,t) e^{(-\theta + \sigma - 1)z} \diff z - x(t)\label{eq:normalized-vm-summary-rescaled}\\
\intertext{Combine \cref{eq:normalized-sp,eq:vt-0-dz} to get}
0 &= (\sigma - 1) v(0,t) + \D[z]v(0,t)\label{eq:normalized-sp-summary-rescaled}
\intertext{Finally, substitute all of the derivatives into \cref{eq:normalized-bellman} and divide by $e^{(\sigma - 1)z}$}
\tilde{\rho}(t)  v(z,t) &= \pi(z,t) + (\mu - g(t) + (\sigma - 1)\upsilon^2)\D[z]v(z,t) + \frac{\upsilon^2}{2}\D[zz]v(z,t) + \D[t]v(z,t)
\intertext{Where,}
\tilde{\rho}(t) &\equiv  r(t) - g(t) - g_w(t) - (\sigma - 1)\left(\mu - g(t) + (\sigma - 1)\frac{\upsilon^2}{2} \right)\label{eq:rhot}
\end{align}

\noindent From (PTW.C.26 to C.28) using the $z\equiv\log(Z/M(t))$ definition,
\begin{align}
	\hat{\pi}(z,t) &= \pi_{\min}(t) e^{(\sigma - 1)z}\left(1 + (N-1)d^{1-\sigma}\indicator{z \geq \log(\hat{z}(t))}\right) - (N-1)\kappa\indicator{z \geq \log(\hat{z}(t))}\label{eq:pi-z-t-summary}
\intertext{Multiply by $e^{-(\sigma - 1)z}$ to get,}
\pi(z,t) &\equiv \bar{\pi}_{\min}(t)\left(1 + (N-1)d^{1-\sigma}\indicator{z \geq \log(\hat{z}(t))}\right) - (N-1)\kappa e^{-(\sigma - 1)z}\indicator{z \geq \log(\hat{z}(t))}
\end{align}

To calculate the profitability ratio of the mean-to-min firm, take from PTW (24) -- keeping in mind the change in notation to $z = \log(Z/M(t))$

\begin{align}
	\bar{\pi}_{\text{rat}}(t) &= \frac{1}{\bar{\pi}_{\min}}\int_0^{\infty} \hat{\pi}(z)f(z)\diff z\\
	\intertext{Use \cref{eq:pi-z-t-summary} and split the integral}
	&= \int_0^{\log(\hat{z}(t))} e^{(\sigma - 1)z} f(z) \diff z
	+  (1 + (N-1)d^{1-\sigma})\int_{\log(\hat{z}(t))}^{\infty}e^{(\sigma - 1)z} f(z) \diff z + (N-1)\frac{\kappa}{\bar{\pi}_{\min}(t)}\int_{\log(\hat{z}(t))}^{\infty}  f(z)\diff z
	\intertext{Use \cref{eq:f-stationary} and simplify}
	&= \theta\frac{1 - \hat{z}(t)^{-\theta + \sigma - 1}}{\theta - \sigma + 1} + (1 + (N-1)d^{1-\sigma})\theta\frac{\hat{z}(t)^{-\theta + \sigma - 1}}{\theta - \sigma + 1} + (N-1)\frac{\kappa}{\bar{\pi}_{\min}(t)} \hat{z}(t)^{-\theta}\\
	&= \notag \frac{\theta}{1 + \theta - \sigma} + (N-1)d^{1-\sigma}\frac{(\sigma-1)\hat{z}^{\sigma-1-\theta}}{1 + \theta - \sigma}
\end{align}


\subsection{Computation of equilibrium $\Omega(t)$ and $E(t)$}\label{sec:Omega-E}


Recall that $E(t)$ is the \textbf{gross} entry flow is $E(t)\Omega(t)$.  Since the \textbf{gross} exit flow is $\delta \Omega(t)$, then the differential equation for $\Omega(t)$ comes from the net flows,
\begin{align}
	\D[t] \Omega(t) &= \left(E(t) - \delta \right)\Omega(t)\label{eq:E-defined-by-Omega}
%	\intertext{Rearrange,}
%	E(t) &\equiv \delta + \D[t]\log \Omega(t)
\end{align}
Which shows that in the steady-state, the entry must simply replace exogenous exit, $E(t) = \delta$ for $t \geq T$.

First, note that $\Omega(t)$ is defined by the solution of the differential equation $	\D[t] \Omega(t) = \left(E(t) - \delta \right)\Omega(t)$ from \cref{eq:E-defined-by-Omega} with boundary conditions of $\Omega(0) = \Omega_0$ and $\Omega(T) = \Omega_T$ where $\Omega_0$ and $\Omega_T$ are the stationary solutions for $\Omega(t)$ at $t = 0$ and $t = T$ respectively. Hence, it suffices to find the equilibrium $E(t)$. On the other hand, note that in steady-state we must have $E(t) = \delta$.  In the computation, we use cubic splines with nodes that are uniformly distributed across $[0,T]$.

To find the equilibrium $E(t)$, we first find $\widehat E(t)$ with an arbitrary endpoint on $[0,T]$ and rescale $\widehat E(t)$ by $Q$
\begin{align}\label{eq:E-normalized-defn}
	Q \widehat E(t) = E(t) - \delta
\end{align}
such that $Q \widehat E(T) = \delta$. Substituting \cref{eq:E-normalized-defn} in \cref{eq:E-defined-by-Omega}, we have
\begin{align}
\D[t] \Omega(t) = Q \widehat{E}(t) \Omega(t)
\end{align}
Solving for $\Omega(t)$, we have
\begin{align}
\Omega_T = \Omega_0 \exp \left(Q \int_0^T \widehat{E}(t) dt\right)
\end{align}
Which yields
\begin{align}
Q = \log \left(\dfrac{\Omega_T}{\Omega_0}\right)\left(\int_0^T \widehat E(t) dt \right)^{-1}
\end{align}
providing the analytic solution for $E(t)$ and $\Omega(t)$ given $\widehat{E} (t)$ with arbitrary endpoints.

\subsection{Free-entry Condition}\label{sec:free-entry}
To determine the $E(t)$ function, we need the free entry complementarity condition to hold.  Note that (PTW D.19) actually holds for any $t$ as well, and does not require the stationary solution.  From (PTW D.19) and using $v(t,0) = \hat{v}(t,0)$, we see that if $E(t) > 0$ then,
\begin{align}
v(t,0) &= \zeta \frac{1-\chi}{\chi}
\intertext{In the case that there is no entry, and $E(t) = 0$ for some $t$, from (PTW D.18)}
v(t,0) &< \zeta \frac{1-\chi}{\chi}
\end{align}

\subsection{Derivation of Rates of Change and Interest Rates}\label{sec:derive-interest-rates}
Since consumption is $C(t) := c(t) M(t)$, take logs and differentiate to get,
\begin{align}
\D[t]\log C(t) &= g(t) + g_c(t)
\intertext{With a CRRA parameter of $\gamma \geq 0$, the interest rate rate faced by a firm is,}
r(t) &= \rho + \delta + \gamma \D[t]\log C(t)\\
&= \rho+ \delta + \gamma(g_c(t)+ g(t))\label{eq:r-def}
\end{align}

\noindent From the PTW (C.34), for $\eta = 0$,
 \begin{align}
 \frac{c(t)}{w(t)}&\propto 1 - \tilde{L}(t)
 \intertext{Take the log and differentiate,}
g_c(t) - g_w(t) &= \D[t]\log\left(1 - \tilde{L}(t)\right)\label{eq:g-c-w-diff}
\intertext{Define,}
\tilde{r}(t) &\equiv r(t) - g(t) - g_w(t)\\
\intertext{From \cref{eq:r-def}}
&= \rho + \delta + \gamma(g_c(t)+ g(t)) - g(t) - g_w(t)\\
&= \rho + \delta + (g_c(t) - g_w(t)) + (\gamma - 1)(g_c(t) + g(t))\\
\intertext{From \cref{eq:g-c-w-diff}}
&= \rho + \delta + \D[t]\log\left(1 - \tilde{L}(t)\right) + (\gamma - 1)(g_c(t) + g(t))\\
\intertext{And in the $\log$ utility case with $\gamma = 1$, the last term drops, so that we have,}
 \tilde{r}(t) &=  \rho+ \delta + \D[t]\log\left(1 - \tilde{L}(t)\right)\label{eq:tilde-r-L}
 \end{align}


 \subsection{Derivations of Cutoffs and Profits}
 From (PTW H.11), the adoption cost relative to wages remains constant throughout the transition (i.e., assumed $\eta = 0$):
 \begin{align}
 x(t) &= \zeta\label{eq:x-zeta}
 \intertext{For the components of aggregate profits, we need to find $\pi_{\min}(t)$. In order to solve for the static $\hat{z}(t)$ condition, we will leave it as a variable in the equations.  Start with (PTW C.26)}
 \pi_{\min}(t) &= \frac{1-\tilde{L}(t)}{(\sigma-1)\bar{z}(t)^{\sigma-1}}\label{eq:pi-min-def}\\
 \intertext{From (PTW C.19), along the transition dynamics $E(t)$ is left general}
 \tilde{L}(t) &=\Omega(t)\left[(N-1)(1-F(\hat{z}(t)))\kappa + \zeta \left( S(t) + E(t)/\chi\right)\right]\label{eq:L-tilde-sub}\\
 &=\Omega(t)\left((N -1)\hat{z}^{-\theta}\kappa + \zeta \left(S(t) + E(t)/\chi \right)\right)\\
 \intertext{From (PTW C.10)}
 \bar{z}(t) &= \left[\Omega(t)\left(\expec{z^{\sigma - 1}} + (N-1)(1-F(\hat{z}(t)))d^{1-\sigma}\condexpec{z^{\sigma - 1}}{z > \hat{z}(t)}\right)\right]^{\frac{1}{\sigma - 1}}\\
 &= \left[\Omega(t)
 \frac{\theta}{1+\theta - \sigma}\left(1 + (N-1)d^{-\theta}\left(\frac{\hat{z}}{d} \right)^{\sigma - 1 -\theta} \right)\right]^{\frac{1}{\sigma - 1}}\label{eq:z-bar-sub}\\
 \end{align}

 \noindent Hence,
 \begin{align}
 \bar{z}(t)^{\sigma - 1}&= \Omega(t)
 \frac{\theta}{1+\theta - \sigma}\left(1 + (N-1)d^{1-\sigma}\hat{z}^{\sigma - 1 -\theta} \right)\label{eq:z-bar-sub-power}\\
 \intertext{Use (PTW C.29)}
 \hat{z}(t)&= d \left(\tfrac{\kappa}{\bar{\pi}_{\min}(t)} \right)^{\frac{1}{\sigma - 1}}\label{eq:z-hat-def}
\intertext{Reorganize \cref{eq:z-hat-def} to find an implicit equation in $\hat{z}$ at every $t$,}
 0&=\hat{z}^{\sigma-1}-  \kappa d^{\sigma - 1} \bar{\pi}_{\min}(t)^{-1}\label{eq:z-hat-power}
 \end{align}
 Note that \cref{eq:z-hat-power} provides an implicit equation in $\hat{z}(t)$ given an exogenous $\Omega(t)$ and $g(t)$ and \cref{eq:L-tilde-sub}, and can be solved separately for each $t$.  From the implicit $\hat{z}(t)$, calculate the home trade share through (PTW C.47),
 \begin{align}
 \lambda_{ii}(t) &= \frac{1}{1 + (N-1)\hat{z}(t)^{\sigma-1-\theta}d^{1-\sigma}}\label{eq:lambda-ii-t}\\
\intertext{Use (PTW C.49) to calculate,}
 \bar{\pi}_{\min}(t) &= \frac{(N-1) \hat z(t) ^{-\theta}\kappa}{1-\lambda_{ii}(t)} \label{eq:pi-bar-t}
 \end{align}

\subsection{Welfare Calculations}
Assume that there is a $T > 0$ such that the equilibrium reaches a steady state.   Given that $g(t) \equiv \D[t]\log M(t)$.  With this,
\begin{align}
M(t) &=M(0)\times\begin{cases}
\exp\left(\int_0^t g(s)\diff s \right) & \text{ if } 0 \leq t \leq T\\
\exp\left(\int_0^{T} g(s)\diff s  + (t - T)\bar{g} \right) & t \geq T
\end{cases}\label{eq:M-t-sol}
\intertext{Assume wlog that $M(0) = 1$, then,}
\log M(t) &= \int_0^t g(s)\diff s\label{eq:log-M}
\end{align}

\subsection*{Intermediate Objects}

Before proceeding, define the following intermediate objects (see Appendix H of PTW):

\begin{align}
	y &= c = (1 - \tilde{L})\bar{z} \\
	\lambda_{ii} &= \frac{1}{1 + (N-1)\hat{z}^{\sigma - 1 - \theta}d^{1-\sigma}}
\end{align}
Note that $y = c$ here because we are only solving the special case of all adoption being done with labor (i.e., $\eta = 0$).


At the steady state, define $\bar{g}$ and $\bar{c}$ as the growth rate and consumption relative to real wages for $t \geq T$.  The consumer welfare can be calculated as from (PTW 1),
\begin{align}
U(t) &= \int_0^{\infty}e^{-\rho \tau}\log C(t+\tau)\diff \tau\\
&= \int_0^{\infty}e^{-\rho \tau}\log M(t+\tau) \diff \tau + \int_0^{\infty}e^{-\rho \tau}\log c(t+\tau)\diff \tau\label{eq:U-def}
\intertext{Given the convergence at time $T$, use \cref{eq:U-def} to split the welfare integral,}
U(t) &= \int_0^{T-t}e^{-\rho \tau}\left(\log M(t+\tau)+\log c(t+\tau)\right)\diff \tau + \int_{T-t}^{\infty}e^{-\rho \tau}\left(\log M(t+\tau)+\log c(t+\tau)\right)\diff \tau\\
\intertext{Note that $c(t)= \bar{c}$ for $t \geq T$,}
&= \int_0^{T-t}e^{-\rho \tau}\left(\log M(t+\tau)+\log c(t+\tau)\right)\diff \tau + \frac{e^{-\rho( T-t)}}{\rho^2}\left(\bar{g} + \rho\left(\log \bar{c} + T \bar{g} \right) \right)\label{eq:U-dynamics}
\intertext{With (PTW G.31) and (PTW G.33) and \cref{eq:f-stationary-summary}}
c(t) &= \left(\frac{\theta}{1-\sigma+\theta}\right)^{\frac{1}{\sigma-1}}\left(1 - \tilde{L}(t)\right)\Omega(t)^{\frac{1}{\sigma - 1}} \lambda_{ii}(t)^{\frac{1}{1-\sigma}}\label{eq:c-def}
\end{align}

\subsection{Consumption Equivalent}
Note that we need to consider if $M(0) \neq 1$.  Modify \cref{eq:log-M}
\begin{align}
\log M(t) &= \log M(0) + \int_0^t g(s)\diff s\label{eq:log-M-notone}\\
\intertext{Hence, modifying \cref{eq:U-def} to get the welfare at time $0$ given a $M(0)$}
U(0; M(0)) &= \log M(0)\int_0^{\infty}e^{-\rho \tau} \diff \tau + \int_0^{\infty}e^{-\rho \tau}\left(\int_0^\tau g(s)\diff s\right)\diff \tau + \int_0^{\infty}e^{-\rho \tau}\log c(\tau)\diff \tau\label{eq:U-def-notone}
\end{align}
If we were in the steady state, then the second two terms are the welfare if $M(0) = 1$, hence,
\begin{align}
U(0, M(0)) &= \frac{\log M(0)}{\rho} + U(0, 1)
\end{align}


Calculate the welfare at the steady state before the shock (which assumes a $M(0) = 1$), defined as $U^{\text{old}}(0)$, then calculate from \cref{eq:U-dynamics} the welfare at time $0$ after the shock as just realized, and calculated as $U(0)$, then to find the indifference level of $M(0)$, equate
\begin{align}
	U(0) &= U^{\text{old}}(0)  + \frac{\log M(0)}{\rho}\\
	\intertext{Solve for $M(0)$}
	M(0) &= \exp \left(\rho(U(0) - U^{\text{old}}(0))\right)
\end{align}

Then the $M(0)$ should be greater than $1$, and it is the inverse of the proportion of consumption the would be willing to give up to change regimes.

For general $\gamma$ (i.e., $\gamma \neq 1$), the result is:

\begin{align}
M(0) &= \left(\frac{U(0)}{U^{\text{old}}(0)}\right)^\frac{1}{1 - \gamma}
\end{align}

\newpage
\bibliography{numerical_algorithm}

\end{document}
